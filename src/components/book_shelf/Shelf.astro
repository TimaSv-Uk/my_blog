---
import BookSpine from "./BookSpine.astro";
const { jsonBooks } = Astro.props;

const bookSizeMinMax = {
  page_px_ratio: 20,
  min_height: 170,
  max_height: 200,
  min_width: 60,
  max_width: 150,
};
---

<div id="shelf" class="shelf-container" style=`
    display: none;

`>
  {
    jsonBooks.map((jsonBook) => (
      <BookSpine jsonBook={jsonBook} bookSizeMinMax={bookSizeMinMax} />
    ))
  }
</div>

<script define:vars={{ jsonBooks, bookSizeMinMax }}>
  const bookCount = jsonBooks.length;

  function chunkArray(arr, numOfChunks) {
    const result = [];
    let chunkSize = Math.floor(arr.length / numOfChunks);
    // console.log(chunkSize)
    for (let i = 0; i < arr.length; i += chunkSize) {
      result.push(arr.slice(i, i + chunkSize));
    }
    return result;
  }
  //TODO:  refactor: calculate number of book on shelf row that will fit on screen
  //FIX: not working 
  function putBooksOnShelfs(bookElemets, shelfWidth) {
    // rowID:[books...]
    //
    //
    let countSelfedBooks = 0;
    let currentShelfRow = 0;
    let avaliableShelfRowSpace = shelfWidth;
    while (countSelfedBooks <= bookElemets.length) {
      let selectedBook = bookElemets[countSelfedBooks];
      if (avaliableShelfRowSpace < bookElemets.width) {
        currentShelfRow++;
        avaliableShelfRowSpace = shelfWidth;
      }
      avaliableShelfRowSpace -= selectedBook.width;
      if (!shelf[`row_${currentShelfRow}`]) {
        shelf[`row_${currentShelfRow}`] = [selectedBook];
        continue;
      }
      shelf[`row_${currentShelfRow}`].push(selectedBook);
    }
    return shelf;
  }
  function setUpShelf(shelfID = "shelf", bookSpine = ".bookSpine") {
    const shelf = document.getElementById(shelfID);

    const booksPerRow = Math.max(
      1,

      Math.floor(
        (bookCount * bookSizeMinMax.max_width) /
          Math.max(bookSizeMinMax.max_width, window.innerWidth),
      ),
    );

    let bookRows = chunkArray(jsonBooks, booksPerRow);

    for (let row = 0; bookRows.length > row; row++) {
      let bookRow = bookRows[row];
      let shelfRow = document.getElementById(`${row}_row`);
      if (shelfRow == null) {
        shelfRow = document.createElement("div");
        shelfRow.id = `${row}_row`;
        shelfRow.className = `shelfRow`;
      }
      // console.log(border.src);
      shelfRow.style = `
        border: 10px solid #D4D9E4; 
        display: flex;
        flex-direction: column;
        width: 90%;
        align-items:center;
        margin: auto, auto;
        `;

      // TODO:
      //  make shelf with flex like with  topBar| BookComponent bootomBat|
      const rowOfBooks = document.createElement("div");
      rowOfBooks.style = `
        display: flex;
        gap: 0.1rem;     
        width: 90%;
        align-items:flex-end;
        margin: auto, auto;
        padding-top: 0.5rem
        `;
      const topShelfBar = document.createElement("div");
      const bottomShelfBar = document.createElement("div");
      topShelfBar.style = `
          background-color: #DD3E65;
          width: 100%;
          height: 20px;
        `;
      bottomShelfBar.style = `
          background-color: #DD3E65;
          width: 100%;
          height: 20px;
        `;
      shelfRow.appendChild(topShelfBar);
      for (let bookIndex = 0; bookRow.length > bookIndex; bookIndex++) {
        let book = bookRow[bookIndex];
        const renderedBook = document.getElementById(`${book.uri}`);
        rowOfBooks.appendChild(renderedBook);
      }

      shelfRow.appendChild(rowOfBooks);
      shelfRow.appendChild(bottomShelfBar);

      shelf.appendChild(shelfRow);
    }
    shelf.style = `
        display: flex;
        flex-wrap: wrap;
        gap: 0.1rem;     
        width: 85%;
        align-items:flex-end;

      `;
  }

  /** remove all elements from shelf exept books */
  function removeEmptyRows(shelfID = "shelf", bookSpine = ".bookSpine") {
    const shelf = document.getElementById(shelfID);

    const bookSpines = shelf.querySelectorAll(bookSpine);

    shelf.replaceChildren(...bookSpines);

  }

  window.addEventListener("DOMContentLoaded", () => {
    requestAnimationFrame(() => {
      setUpShelf();
    });
  });
  window.addEventListener("resize", () => {
    requestAnimationFrame(() => {
      removeEmptyRows();
      setUpShelf();
    });
  });

  // const bookSpines = document.querySelectorAll(`.bookSpine`);
  // bookSpines.forEach((book) => {
  //   book.addEventListener("click", () => {
  //     console.log(book);
  //   });
  // });
</script>

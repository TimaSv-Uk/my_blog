---
const { jsonBook, bookSizeMinMax } = Astro.props;
import { RNG } from "./randomNuberSeed.js";

const dataDocSizeData = JSON.parse(jsonBook.data.doc_position);

let book_seed = jsonBook.uri.split("").reduce((a, b) => a + b.charCodeAt(0), 0);
book_seed = new RNG(book_seed).nextInt();

let book_height = book_seed % bookSizeMinMax.max_height;
book_height = Math.max(bookSizeMinMax.min_height, book_height);

let book_width = dataDocSizeData.pagesCount / bookSizeMinMax.page_px_ratio;
book_width = Math.max(bookSizeMinMax.min_width, book_width);
book_width = Math.min(bookSizeMinMax.max_width, book_width);

const roll = Math.floor(Math.random() * 10) + 1;
if (roll === 1) {
  //console.log("1 out of 10 hit!");
  book_width /= 0.8;
}

// Random Letter Spacing (between -0.1em and 0.05em)
const letterSpacing = (Math.random() * (0.05 - -0.1) + -0.1).toFixed(3);

// Random Font Selection
const fonts = ["serif", "sans-serif", "monospace", "system-ui"];
const randomFont = fonts[book_seed % fonts.length];

const title_font_weight = Math.max(book_seed % 1200, 800);

const isFavorite = jsonBook.data.doc_favorites_time > 0;
const bookStyle = `
  background: #3E4B5B;
  border: 2px solid ${isFavorite ? "#B48EAD" : "#81A1C1"};
  text-wrap: wrap;
  color: ${isFavorite ? "#B48EAD" : "#81A1C1"};
  width: ${book_width}px;
  height: ${book_height}px;
`;
let randomColor = "#" + ((book_seed * 0xffffff) << 0).toString(16);

let bookTitle = jsonBook.data.doc_title ?? "Title";
//NOTE:
// title of books cleaner on Spines: filter all in "()" words, filter all after ":"
function removeParentheses(text) {
  let result = "";
  let depth = 0;

  for (let char of text) {
    if (char === "(") {
      depth++; // Enter a parenthesis, start ignoring text
    } else if (char === ")" && depth > 0) {
      depth--; // Exit a parenthesis
    } else if (depth === 0) {
      result += char; // Only add text if we are not inside parentheses
    }
  }

  return result.trim();
}
bookTitle = bookTitle.split(":")[0];
bookTitle = removeParentheses(bookTitle);

let filterdBookTitle = bookTitle
  ? bookTitle.split(" ").slice(0, 6).join(" ").trimEnd()
  : "TITLE";

let fontReferenceWidth =
  (bookSizeMinMax.min_width + bookSizeMinMax.min_width) / 2;

let bookTitleFontSize = `${fontReferenceWidth}px`;
switch (true) {
  case bookTitle.length > 40:
    bookTitleFontSize = `${fontReferenceWidth / 5.5}px`;
    break;
  case bookTitle.length > 25:
    bookTitleFontSize = `${fontReferenceWidth / 5.5}px`;
    break;
  case bookTitle.length > 15:
    bookTitleFontSize = `${fontReferenceWidth / 4}px`;
    break;
  case bookTitle.length > 10:
    bookTitleFontSize = `${fontReferenceWidth / 3}px`;
    break;
  default:
    bookTitleFontSize = `${fontReferenceWidth / 2.5}px`;
}

// TODO: handle EXEPTION large title on small books  is overflowing
function wrapBookTitle(title) {
  if (!title) {
    return "TITLE";
  }
  title = title.trimEnd();
  title = title.split(" ");
  let charCount = 0;
  for (let i = 0; i < title.length; i += 2) {
    let previosCharCount = charCount;
    charCount += title[i].length;

    if (charCount >= 15 && charCount - previosCharCount > 3) {
      title[i] += "<br>";
    }
  }
  return title.join(" ");
}
filterdBookTitle = wrapBookTitle(filterdBookTitle);

function glueArticles(text) {
  // List of words that should never sit at the end of a line
  const articles = [
    "of",
    "the",
    "a",
    "an",
    "and",
    "in",
    "on",
    "with",
    "for",
    "by",
  ];

  let words = text.split(" ");

  for (let i = 0; i < words.length - 1; i++) {
    // If the current word is in our list, swap the space after it for a non-breaking space
    if (articles.includes(words[i].toLowerCase())) {
      words[i] = words[i] + "\u00A0";
      words[i] = words[i] + words[i + 1];
      words.splice(i + 1, 1);
    }
  }
  return words.join(" ");
}

// Apply it to your title
filterdBookTitle = glueArticles(filterdBookTitle);
---

<div id={jsonBook.uri} class="bookSpine" style={bookStyle}>
  <a href=`${import.meta.env.BASE_URL}/books/${jsonBook.uri}`>
    <div
      style=`
          background: ${randomColor};
          height: 20%;
          opacity: 0.5;
          text: #E3E7EE;
        `
    >
    </div>
    <div
      style=`
          background: #252932;
          height: 80%;
          display:flex;
          align-items:center;
          justify-content:center;
          overflow: hidden;
        `
    >
      <div
        style=`
            text-wrap: pretty;
            font-weight: ${title_font_weight};
            letter-spacing: ${letterSpacing}em;
            font-family: ${randomFont};
            transform: rotate(-90deg);
            font-size: ${bookTitleFontSize};
            align-items: center;
          `
        set:html={filterdBookTitle}
      />
    </div>
  </a>
</div>

<style>
  .book {
    transform-style: preserve-3d;
    box-shadow:
      10px 10px 0 #636363,
      10px 10px 0 #636363;
  }

  a {
    all: unset;
    cursor: pointer;
  }
  .bookSpine {
    background-color: var(--randomColor);
    background-image: linear-gradient(
      90deg,
      rgba(255, 255, 255, 0.2) 0%,
      rgba(255, 255, 255, 0) 20%,
      rgba(0, 0, 0, 0.1) 80%,
      rgba(0, 0, 0, 0.4) 100%
    );

    /* Shadow for depth */
    box-shadow:
      inset 2px 0 5px rgba(255, 255, 255, 0.3),
      /* Highlight left */ inset -2px 0 5px rgba(0, 0, 0, 0.3),
      /* Shadow right */ 5px 5px 10px rgba(0, 0, 0, 0.3); /* Drop shadow */

    transition:
      transform 0.3s ease,
      box-shadow 0.3s ease;
  }
  /* Hover Effect: Pull book out */
  .bookSpine:hover {
    transform: translateY(-10px) translateX(-5px);
    box-shadow:
      inset 2px 0 5px rgba(255, 255, 255, 0.3),
      10px 15px 20px rgba(0, 0, 0, 0.4);
  }
</style>

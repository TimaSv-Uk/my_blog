---
const { json_book } = Astro.props;

import fs from 'fs/promises';
import path from 'path';
// DATA type
// {
//     "uri": "sha-1:842c0a4485103e4f65642b2cc679fc5eb52a05a8",
//     "data": {
//         "doc_md5": "2cf113d6b5872889118323775017239d",
//         "doc_sha1": "842c0a4485103e4f65642b2cc679fc5eb52a05a8", "doc_active": 1,
//         "doc_format": "EPUB",
//         "doc_file_name_title": "Slewfoot (Brom) ",
//         "doc_modified_time": 1759996882950,
//         "doc_file_size": 1225254,
//         "doc_title": "Slewfoot",
//         "doc_authors": "Brom",
//         "doc_annotation": "Set in Colonial New England, Slewfoot is a tale of magic and mystery, of triumph and terror as only dark fantasist Brom can tell it. \nConnecticut, 1666. \nAn ancient spirit awakens in a dark wood. The wildfolk call him Father, slayer, protector.\nThe colonists call him Slewfoot, demon, devil.\nTo Abitha, a recently widowed outcast, alone and vulnerable in her pious village, he is the only one she can turn to for help. \nTogether, they ignite a battle between pagan and Puritan &#8211; one that threatens to destroy the entire village, leaving nothing but ashes and bloodshed in their wake. \n\"If it is a devil you seek, then it is a devil you shall have!\" \nThis terrifying tale of bewitchery features more than two dozen of Brom's haunting paintings, fully immersing readers in this wild and unforgiving world.\nAt the Publisher's request, this title is being sold without Digital Rights Management Software (DRM) applied.",
//         "meta_extra_version": 0,
//         "file_modified_time": 1759729813000,
//         "doc_colls_count": 2,
//         "doc_lang": "en",
//         "doc_embeded_thumb_version": 1,
//         "doc_first_page_thumb_version": 0,
//         "doc_metadata_version": 2,
//         "doc_embedded_fonts_count": 0,
//         "doc_vertical_layout": 0,
//         "doc_delete_time": 0,
//         "doc_last_read_time": 1759931713876,
//         "doc_activity_time": 1759931713876,
//         "doc_favorites_time": 1759996878481,
//         "doc_have_read_time": 1759996882948,
//         "doc_to_read_time": 0,
//         "doc_position": "{\"ratio\":0.0048833423765599565,\"configHash\":-616182448,\"page\":9,\"pagesCount\":1844,\"offsetX\":0,\"offsetY\":0,\"zoom\":1,\"originPage\":-1,\"xPath\":\"\\/body\\/DocFragment[8]\\/body\\/html\\/body\\/section\\/header\\/p\\/text().0\",\"pageEnd\":-1,\"version\":2}",
//         "doc_bookmarks": "[]",
//         "doc_search_tips": "[]",
//         "doc_rating": 0
//     },
//     "aliases": [
//         "size:1225254-1762608346375-24117RN76E"
//     ],
//     "bookmarks": [],
//     "citations": [],
//     "reviews": [],
//     "links": []
// }

const isFavorite = json_book.data.doc_favorites_time > 0;
const bookStyle = `
  background: #3E4B5B;
  border: 2px solid ${isFavorite ? "#B48EAD" : "#81A1C1"};
  color: ${isFavorite ? "#B48EAD" : "#81A1C1"}; ${isFavorite ? "margin-bottom: 2px;" : ""}
  width: content-fit;

      // transform: rotate(90deg) scaleX(-1);
   
`;
async function getRealPageCount(title, author) {
    // 1. Clean up the query
    const query = `title=${encodeURIComponent(title)}&author=${encodeURIComponent(author)}`;
    const url = `https://openlibrary.org/search.json?${query}&fields=number_of_pages_median,title`;
    console.log(url)

    try {
        const response = await fetch(url);
        const data = await response.json();

        if (data.docs && data.docs.length > 0) {
            const book = data.docs[0];
            
            if (book.number_of_pages_median) {
                return book.number_of_pages_median;
            }
        }
        
        console.warn("Book found, but no page count available.");
        return null;

    } catch (error) {
        console.error("API Error:", error);
        return null;
    }
}



getRealPageCount(json_book.data.doc_title, json_book.data.doc_authors).then(realPages => {
    if (realPages) {
        console.log("-----")
        console.log(json_book.data.doc_title, json_book.data.doc_author)
        console.log("Real Physical Pages:", realPages);

    }
});

const prefsReadEraPath = path.resolve('./src/readEra_backup/prefs.xml');
const prefsReadEraXMLText = await fs.readFile(prefsReadEraPath, 'utf-8');
---

<div
  id={json_book.uri}
  class="book"
  style={bookStyle}
>
  {json_book.data.doc_title} -- {json_book.data.doc_have_read_time}
</div>

<script define:vars={{json_book,prefsReadEraXMLText}}>

  const parser = new DOMParser();
  const doc = parser.parseFromString(prefsReadEraXMLText, "text/xml");

  const font_size_reflowable = 
  [...doc.getElementsByTagName("String")].find(
    (el) => el.getAttribute("name") === "pref_reflowable_font_size").textContent
  
// .pref_reflowable_font_size
  const book = document.getElementById(`${json_book.uri}`);
  const dataDocSizeData = JSON.parse(json_book.data.doc_position)
  book.addEventListener('click', () => {
    // console.log(book.id,json_book.data.doc_title, dataDocSizeData.pagesCount)
    // console.log(dataDocSizeData.pagesCount);

    const ratio = font_size_reflowable/dataDocSizeData.pagesCount;
    const font_size = ratio * dataDocSizeData.pagesCount  
    console.log("dataDocSizeDatao: ",dataDocSizeData)
    console.log(font_size)
    
    // only works for IT King 
    // const real_page_count = 1348 
    // const readera_font_dended_page_count = 3445 
    // only works for all the sinner bleed
    const real_page_count = 339 
    let readera_font_dended_page_count = 746 
    readera_font_dended_page_count =  216
      
    const page_ratio = readera_font_dended_page_count/real_page_count

    const correct_font_size =  Math.round(dataDocSizeData.pagesCount / page_ratio)
    console.log("dataDocSizeDatao: ",correct_font_size)
    });
</script>
